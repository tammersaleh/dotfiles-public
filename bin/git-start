#!/usr/bin/env bash

set -euo pipefail
shopt -s inherit_errexit

main() {
  # shellcheck disable=2016
  [[ $# -eq 1 ]] || usage 'Must give the issue number.  Try `git issue`'
  [[ $1 =~ ^[0-9]+$ ]] || usage 'Issue number must be numeric.  Duh.'
  issue_number="$1"
  branch="tammersaleh/$issue_number"
  main=$(git rev-parse --abbrev-ref HEAD)
  message=$(hub issue show -f "%t%n%n%b%n%n[closes #$issue_number]" "$issue_number")

  set -x
  hub issue update -a tammersaleh "$issue_number"
  hub api "repos/{owner}/{repo}/issues/$issue_number/comments" --raw-field "body=Work being done in $branch"
  git push origin "$main:refs/heads/$branch"
  git fetch origin
  git branch "$branch" "origin/$branch"
  git checkout "$branch"
  git commit -m "$message" --allow-empty
  git push
}

usage() {
  [[ $# -gt 0 ]] && echo "ERROR: $*"
  local me=$(basename "$0")
  cat <<-EOF

  USAGE: $me ISSUE_NUMBER

  Start working on an issue.  Updates github, assigning the issue to yourself.
  Creates a new branch for the issue.  Creates a commit that will close the
  issue.

  Examples:

    git start 123

  See also: git finish
	EOF
  exit 1
}

main "$@"

